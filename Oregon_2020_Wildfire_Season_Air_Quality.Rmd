---
title: "Oregon 2020 Wildfire Season: Air Quality"
author: "Astrid Sanna"
date: "2021-01-14"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Maps and Timeseries Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
```

When we think of wildfires in the United States, the consequences of their destructive force and the need for preventive emergency plans are the first things that come to mind, especially if we live in high-risk regions such as the Pacific North West (PNW). Indeed, Oregon was one of the states of the PNW most affected by this past wildfire season, and we can all vividly recall the news about people forced to leave their homes for good in order to escape the incoming wildfires. The 2020 [wildfire season]( https://en.wikipedia.org/wiki/2020_Oregon_wildfires) was the worst of Oregon’s history, with 90% of the wildfires caused by people and further exacerbated by remarkably strong winds and dry weather. However, what was destroyed and lost is just a part of the tragedy. This article is meant to inform about the aftermath of wildfire events in Oregon, giving a closer look at the [air quality]( https://www.oregon.gov/oha/PH/HEALTHYENVIRONMENTS/TRACKINGASSESSMENT/ENVIRONMENTALPUBLICHEALTHTRACKING/Pages/EPHT-Indicator-Outdoor-Air.aspx) index (AQI) during the last Fall season (09/22/2020 – 12/21/2020) with a focus on small particulates (PM2.5) generated by wildfire smoke – which can cause severe respiratory issues. 

According to the [AirNow](https://www.airnow.gov/) ambient monitoring data represented in the map below, many monitoring sites recorded days with unhealthy and USG (Unhealthy for Sensitive Groups) levels of PM2.5.  

```{r, Oregon latest, message = FALSE, echo=FALSE}
#the code below combines the California code example and the Maps_and_timeseries_plots code example.

suppressPackageStartupMessages(library(PWFSLSmoke))
OR_latest <-
  monitor_loadLatest() %>%
  monitor_subset(stateCodes = c("OR"))
OR_IDs <- OR_latest$meta$monitorID
OR_fall2020 <- monitor_load(startdate = 20200922, enddate =20201221, monitorIDs = OR_IDs,  parameter = "PM2.5")
OR_fall24 <- monitor_rollingMean(OR_fall2020, width = 24)
```


```{r map, echo= FALSE}
monitor_map(OR_fall24, slice = max)
addAQILegend(title = "Max AQI", cex = 0.7, x = "bottomright")

```

(*__Note__ that this is not the regulatory midnight-to-midnight AQI but a continuous 24-hr rolling mean.*)

More details about each monitoring site including specific PM2.5 levels can be explored by navigating the dynamic map below. 

```{r leaflet, echo= FALSE}
monitor_leaflet(OR_fall24, slice = max) 
```

As you notice, Josephine and Jackson counties were among those with the worst air-quality days, and the following time series plot shows which period in the Fall season was the worst. Accounting for the missing data of the entire month of November, through visual examination we can agree that the last week of September and roughly the first two weeks of October were the most alarming (09/22/2020 – 10/12/2020).

```{r dygraph, echo=FALSE}

#create a time series for v.unhealthy sites.
v.unhealthy.id <- c("410330036_01", "410330114_01", "410330011_01","410292129_01","410290201_01","410290203_01")
v.unhealthy <- monitor_subset(OR_fall2020, monitorIDs = v.unhealthy.id)
monitor_timeseriesPlot(v.unhealthy, style = 'gnats')
title('Josephine and Jackson counties, Fall 2020')
addAQILines()
addAQILegend(cex = 0.7)

```


```{r sept-oct subset: 09/22/2020 – 10/12/2020, echo=FALSE}

OR_fall2020.sb <- monitor_subset(OR_fall2020, tlim = c(20200922, 20201012),
                        timezone = "America/Los_Angeles")
OR_fall24.sb <- monitor_subset(OR_fall24, tlim = c(20200922, 20201012),
                           timezone = "America/Los_Angeles")
v.unhealthy.sb <- monitor_subset(v.unhealthy, tlim = c(20200922, 20201012),
                           timezone = "America/Los_Angeles")
```

Further analysis of some of the monitoring sites with the highest midnight-to-midnight AQI levels reveals us that the Cave Junction Forest Service site was the one with the greatest number of days with unhealthy levels of PM2.5 during the time period (see graphic below). The site was also the worst one for chronic smoke (AQI greater or equal to 55.5 PM2.5) followed by the Provolt - Seed Orchard and Medford Welch & Jackson sites.  

```{r dailyBarplot, fig.height = 10, echo=FALSE}

#mine (may need to fix axes = FALSE)
layout(matrix(seq(6)))
opar <- par(mar = c(1,1,1,1)) # image for margins 
on.exit(par(opar))
for (monitorID in v.unhealthy.id) {
  siteName <- v.unhealthy.sb$meta[monitorID, 'siteName']
  monitor_dailyBarplot(
    v.unhealthy.sb,
    monitorID = monitorID,
    main = siteName,
    axes = FALSE
  )
}
par(opar)
layout(1)
```


```{r acute, echo=FALSE, results='hide'}

data <- OR_fall2020$data[,-1] # omit 'datetime' column
maxPM25 <- apply(X = data, MARGIN =  2, FUN = max, na.rm = TRUE) # maximum value at each site (2 = columns)
worstAcute <- names(sort(maxPM25, decreasing = TRUE))[1:6] # monitorIDs for the 6 worst sites in OR (each column name corresponds to the monitorID)
dplyr::intersect(worstAcute, v.unhealthy.id) #use intersect from package dplyr - 3 v.unhealthy.id out 6 were also "worstAcute"
OR_fall2020.sb$meta[worstAcute[1],c('siteName','countyName','stateCode')] #Cave Junction Forest Service

```


```{r dailyStatistic, warning = FALSE, echo=FALSE, results='hide'}
# similar analysis for chronic smoke. In this case we will calculate 
# the number of days at or above the AQI "unhealthy" level

OR_fall2020_dailyAvg <- monitor_dailyStatistic(OR_fall2020, FUN = mean, minHours = 20)
data.daily <- OR_fall2020_dailyAvg$data[,-1]
unhealthyDays <- apply(data.daily, 2, function(x) { sum(x >= AQI$breaks_24[4], na.rm = TRUE) }) #above 55.5
worstChronic <- names(sort(unhealthyDays, decreasing = TRUE))[1:6]
dplyr::intersect(worstChronic, v.unhealthy.id) #5 v.unhealthy.id were also "worstChronic"
OR_fall2020.sb$meta[worstChronic[1:3],c('siteName','countyName','stateCode')] #Cave Junction Forest Service

#                                 siteName countyName stateCode
# 410330036_01 Cave Junction Forest Service  Josephine        OR
# 410330011_01       Provolt - Seed Orchard  Josephine        OR
# 410292129_01      Medford Welch & Jackson    Jackson        OR

```

Started in California, the wildfire that burned in Josephine county was one of the largest of the season as illustrated in the table and map below. Moreover, the Lionshead and The Beachie Creek fires were two of the three wildfires that then merged into the 402,274-acre [Santiam fire](https://en.wikipedia.org/wiki/Santiam_Fire), which was finally contained in December. 

```{r df of largest wildfires, echo= FALSE, results='hide'}
counties = c("Jefferson, Linn, Marion, Wasco", "Clackamas, Linn, Marion", "Lane, Linn", "Josephine", "Clackamas", "Douglas")
fire_name = c("Lionshead", "Beachie Creek", "Holiday Farm", "Slater", "Riverside", "Archie Creek")
acres = c("204,469", "193,573","173,393", "157,220", "138,054", "131,542")
start_date = c("August 16", "August 16", "September 7", "September 8", "September 8","September 8")
df = data.frame(counties,fire_name, acres, start_date)


```

```{r kable table, echo= FALSE}
library(knitr)
col.names = c("Counties", "Fire name", "Acres", "Ignition date")
kable(df,col.names = col.names, format = "html", align = 'l', caption = "Oregon Largest Wildfires")
```


```{r staticmap, fig.width=5, fig.height=5, fig.align="center", echo=FALSE}
#removed eval=FALSE and fixed typo in function monitor_staticMap --> monitor_staticmap

fireLons <- c(-123.375, -122.713, -122.683, -122.188, -122.231, -122.062, -122.788)
fireLats <- c(41.766, 42.211, 42.467, 44.821, 44.172, 45.049, 43.334)
monitor_staticmap(
  OR_fall2020_dailyAvg,
  slice = max,
  maptype = 'terrain',
  centerLon = mean(fireLons),
  centerLat = mean(fireLats),
  zoom = 7
)
addIcon('redFlame', fireLons, fireLats, expansion = .002)
addAQILegend(cex = 0.8, x = "bottomleft")
title("September - October, 2015", line = -1.5, cex.main = 2)
layout(1)

# fire info from https://en.wikipedia.org/wiki/2020_Oregon_wildfires#List_of_wildfires
# most of coordinaes from https://inciweb.nwcg.gov/
# Josephine County: Slater fire, Originally started in California then spread to Josephine County, coordinates 41.766, -123.375
# Jackson County: Almeda Drive fire, coordinates 42.211, -122.713
# Jackson County (smaller): South Obenchain fire: 42.467, -122.683 (euclidean distance from previous ~ 12 miles)
# Santiam Fire: 44.821, -122.188 (204,469, Lionshead and The Beachie Creek were 2 of 3 fires that created the santima fire)
# Holiday Farm Fire: 44.172, -122.231
# Riverside fire: 45.049, -122.062
# Archie Creek Fire: 43.334, -122.788 

```

From this map we can see that Josephine and Jackson counties were scorched by three fires. Based on further analysis the six monitoring sites in their proximity were those with the worst AQI levels in the entire state during Fall. Additional investigation on wind direction and force is needed to define to what degree the other large fires could have affected Josephine and Jackson counties air quality. 

```{r tribalMonitors_daily, echo= FALSE}
# I wasn't sure about how to find "tribal monitors" so i'm using the 2 sites with the worstChronic days during sept-oct to show you how I manipulate the code. However since the results are redundant with previous analysis. I', commenting the entire code chunk out. 

#OR_fall2020.sb$meta[worstChronic[1:2],c('siteName','countyName','stateCode')] 
# 410330036_01 Cave Junction Forest Service  Josephine        OR
# 410330011_01       Provolt - Seed Orchard  Josephine        OR

# Cave_Junction <- monitor_subset(OR_fall2020.sb, monitorIDs = "410330036_01")
# Provolt <- monitor_subset(OR_fall2020.sb, monitorIDs = "410330011_01")
# 
#layout(matrix(seq(2)))
# monitor_dailyBarplot(
#   Cave_Junction,
#   main = "Sept-Oct 2020 Daiy AQI -- Cave Junction, OR",
#   labels_x_nudge = 0.8,
#   labels_y_nudge = 100
# )
# monitor_dailyBarplot(
#   Provolt,
#   main="Sept-Oct 2020 Daily AQI -- Provolt, OR",
#   labels_x_nudge = 0.8,
#   labels_y_nudge = 100
# )
# layout(1)
```

